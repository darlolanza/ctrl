<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas Flow - Control de Gastos</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        /* Ajustes globales */
        body {
            background-color: #020617;
            /* slate-950 */
        }

        /* Scrollbar oculta pero funcional */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Soporte para notch de iPhone */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Plus, Minus, Wallet, CreditCard, TrendingUp, TrendingDown,
            DollarSign, User, Save, PieChart, List, Home, Target,
            Snowflake, Check, X, Calendar, Percent, ChevronLeft,
            ChevronRight, Trash2, Landmark, CalendarClock, PiggyBank, RefreshCw, Upload, Download, Edit2
        } from 'lucide-react';

        // --- SUPABASE CONFIGURATION ---
        // TODO: REEMPLAZAR ESTOS VALORES CON LOS DE TU PROYECTO SUPABASE
        const SUPABASE_URL = 'https://jvastuwfzfoiehsbubzr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2Et3jqrPfCyfBANfscQZWw_MweKm8uw';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- SUPABASE SERVICE ---
        const SupabaseService = {
            async getAllData() {
                try {
                    const [transactions, fixed, cards, goals, settings] = await Promise.all([
                        supabase.from('transactions').select('*').order('date', { ascending: false }),
                        supabase.from('fixed_expenses').select('*'),
                        supabase.from('credit_cards').select('*'),
                        supabase.from('savings_goals').select('*'),
                        supabase.from('app_settings').select('*')
                    ]);

                    if (transactions.error) throw transactions.error;
                    if (fixed.error) throw fixed.error;
                    if (cards.error) throw cards.error;
                    if (goals.error) throw goals.error;
                    if (settings.error) throw settings.error;

                    // Transform Fixed Expenses to Map by Month
                    const fixedHistory = {};
                    fixed.data.forEach(item => {
                        if (!fixedHistory[item.month_key]) fixedHistory[item.month_key] = [];
                        fixedHistory[item.month_key].push({
                            ...item,
                            endMonth: item.end_month, // map snake_case to camelCase
                            monthKey: item.month_key
                        });
                    });

                    // Get Config
                    const configRow = settings.data.find(r => r.key === 'config');
                    const config = configRow ? configRow.value : { exchangeRate: 1120 };

                    return {
                        transactions: transactions.data.map(t => ({
                            ...t,
                            monthKey: t.month_key,
                            cardId: t.card_id,
                            cardName: t.card_name,
                            purchaseDate: t.date, // mapping back
                            isInstallment: t.is_installment,
                            originalAmount: t.original_amount
                        })),
                        fixedExpensesHistory: fixedHistory,
                        creditCards: cards.data.map(c => ({
                            ...c,
                            closingDay: c.closing_day,
                            dueDay: c.due_day,
                            previousAmount: Number(c.previous_amount || 0)
                        })),
                        savingsGoals: goals.data,
                        exchangeRate: config.exchangeRate
                    };
                } catch (error) {
                    console.error("Error fetching data:", error);
                    // alert("Error obteniendo datos: " + error.message); // Removed debug alert
                    return null;
                }
            },

            // --- WRITE OPERATIONS ---
            async addTransaction(transaction) {
                const { id, type, amount, category, description, user, date, monthKey, method, cardId, installments, interest, discount, isInstallment, originalAmount, cardName } = transaction;

                const { error } = await supabase.from('transactions').insert({
                    id, type, amount, category, description,
                    user_name: user,
                    date,
                    month_key: monthKey,
                    method,
                    card_id: cardId || null,
                    installments, interest, discount,
                    is_installment: isInstallment || false,
                    original_amount: originalAmount || null,
                    card_name: cardName || null
                });
                if (error) {
                    console.error("Error adding transaction:", error);
                    alert("Error agregando transacci√≥n (" + error.code + "): " + error.message);
                }
                return !error;
            },

            async deleteTransaction(id) {
                const { error } = await supabase.from('transactions').delete().eq('id', id);
                if (error) alert("Error eliminando transacci√≥n: " + error.message);
                return !error;
            },

            async updateTransaction(transaction) {
                const { id, type, amount, category, description, user, date, monthKey, method, cardId, installments, interest, discount, isInstallment, originalAmount, cardName } = transaction;

                // For now, simpler update: recreate logic or just update fields
                const { error } = await supabase.from('transactions').update({
                    type, amount, category, description,
                    user_name: user,
                    date,
                    month_key: monthKey,
                    method,
                    card_id: cardId || null,
                    installments, interest, discount,
                    is_installment: isInstallment || false,
                    original_amount: originalAmount || null,
                    card_name: cardName || null
                }).eq('id', id);

                if (error) {
                    console.error("Error updating transaction:", error);
                    alert("Error actualizando transacci√≥n: " + error.message);
                }
                return !error;
            },

            async addFixedExpense(expense, monthKey) {
                const { id, name, projected, real, paid, endMonth } = expense;
                const { error } = await supabase.from('fixed_expenses').insert({
                    id, name, projected, real, paid,
                    month_key: monthKey,
                    end_month: endMonth
                });
                if (error) {
                    console.error("Error adding fixed expense:", error);
                    alert("Error agregando gasto fijo (" + error.code + "): " + error.message);
                }
                return !error;
            },

            async updateFixedExpense(id, field, value) {
                // Map camelCase fields to snake_case for DB
                const fieldMap = { 'endMonth': 'end_month', 'monthKey': 'month_key' };
                const dbField = fieldMap[field] || field;

                const { error } = await supabase.from('fixed_expenses').update({ [dbField]: value }).eq('id', id);
                if (error) {
                    console.error("Error updating fixed expense:", error);
                    alert("Error actualizando gasto fijo: " + error.message);
                }
                return !error;
            },

            async deleteFixedExpense(id) {
                const { error } = await supabase.from('fixed_expenses').delete().eq('id', id);
                if (error) alert("Error eliminando gasto fijo: " + error.message);
                return !error;
            },

            async addCard(card) {
                const { id, name, bank, closingDay, dueDay, color } = card;
                const { error } = await supabase.from('credit_cards').insert({
                    id, name, bank, color,
                    closing_day: closingDay,
                    due_day: dueDay,
                    previous_amount: card.previousAmount || 0
                });
                if (error) alert("Error agregando tarjeta: " + error.message);
                return !error;
            },

            async updateCard(id, field, value) {
                const fieldMap = { 'closingDay': 'closing_day', 'dueDay': 'due_day', 'previousAmount': 'previous_amount' };
                const dbField = fieldMap[field] || field;
                const { error } = await supabase.from('credit_cards').update({ [dbField]: value }).eq('id', id);
                if (error) alert("Error actualizando tarjeta: " + error.message);
                return !error;
            },

            async deleteCard(id) {
                const { error } = await supabase.from('credit_cards').delete().eq('id', id);
                if (error) alert("Error eliminando tarjeta: " + error.message);
                return !error;
            },

            async addGoal(goal) {
                const { id, name, target, current, currency } = goal;
                const { error } = await supabase.from('savings_goals').insert({
                    id, name, target, current: current || 0, currency
                });
                if (error) alert("Error agregando meta: " + error.message);
                return !error;
            },

            async updateGoal(id, field, value) {
                const { error } = await supabase.from('savings_goals').update({ [field]: value }).eq('id', id);
                if (error) alert("Error actualizando meta: " + error.message);
                return !error;
            },

            async deleteGoal(id) {
                const { error } = await supabase.from('savings_goals').delete().eq('id', id);
                if (error) alert("Error eliminando meta: " + error.message);
                return !error;
            },

            async updateExchangeRate(rate) {
                // We store basics in 'config' key
                const { error } = await supabase.from('app_settings').upsert({
                    key: 'config',
                    value: { exchangeRate: Number(rate) }
                });
                if (error) alert("Error actualizando configuraci√≥n: " + error.message);
                return !error;
            },

            async migrateData(localData) {
                // Batch insert transactions
                if (localData.transactions && localData.transactions.length > 0) {
                    const mappedTrans = localData.transactions.map(t => ({
                        id: t.id, type: t.type, amount: t.amount, category: t.category, description: t.description,
                        user_name: t.user, date: t.date || t.purchaseDate, month_key: t.monthKey, method: t.method,
                        card_id: t.cardId || null, installments: t.installments || 1, interest: t.interest || 0,
                        discount: t.discount || 0, is_installment: t.isInstallment || false,
                        original_amount: t.originalAmount || null, card_name: t.cardName || null
                    }));
                    await supabase.from('transactions').upsert(mappedTrans);
                }

                // Cards
                if (localData.creditCards) {
                    const mappedCards = localData.creditCards.map(c => ({
                        id: c.id, name: c.name, bank: c.bank, color: c.color,
                        closing_day: c.closingDay, due_day: c.dueDay
                    }));
                    await supabase.from('credit_cards').upsert(mappedCards);
                }

                // Goals
                if (localData.savingsGoals) {
                    await supabase.from('savings_goals').upsert(localData.savingsGoals);
                }

                // Fixed Expenses
                if (localData.fixedExpensesHistory) {
                    let allFixed = [];
                    Object.entries(localData.fixedExpensesHistory).forEach(([mKey, expenses]) => {
                        expenses.forEach(e => {
                            allFixed.push({
                                id: e.id, name: e.name, projected: e.projected, real: e.real, paid: e.paid,
                                month_key: mKey, end_month: e.endMonth
                            });
                        });
                    });
                    if (allFixed.length > 0) await supabase.from('fixed_expenses').upsert(allFixed);
                }

                // Config
                if (localData.exchangeRate) {
                    await supabase.from('app_settings').upsert({ key: 'config', value: { exchangeRate: localData.exchangeRate } });
                }
            }
        };

        // --- COMPONENTES UI REUTILIZABLES ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 rounded-2xl border border-slate-700 shadow-lg ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", type = "button" }) => {
            const baseStyle = "px-4 py-3 rounded-xl font-semibold transition-all duration-200 active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-amber-500 hover:bg-amber-400 text-slate-900 shadow-amber-500/20 shadow-lg",
                secondary: "bg-slate-700 hover:bg-slate-600 text-white",
                danger: "bg-rose-500/10 text-rose-400 hover:bg-rose-500/20",
                ghost: "bg-transparent hover:bg-slate-700 text-slate-400 hover:text-white"
            };
            return (
                <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, value, onChange, type = "text", placeholder, name, icon: Icon, className = "" }) => (
            <div className={`flex flex-col gap-1.5 w-full ${className}`}>
                {label && <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{label}</label>}
                <div className="relative">
                    <input
                        type={type}
                        name={name}
                        value={value}
                        onChange={onChange}
                        placeholder={placeholder}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors text-sm font-medium"
                    />
                    {Icon && (
                        <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none">
                            <Icon size={16} />
                        </div>
                    )}
                </div>
            </div>
        );

        const StableInput = ({ value, onCommit, className, placeholder, type = "text" }) => {
            const [localValue, setLocalValue] = useState(value);

            useEffect(() => {
                setLocalValue(value);
            }, [value]);

            return (
                <input
                    type={type}
                    className={className}
                    value={localValue}
                    onChange={(e) => setLocalValue(e.target.value)}
                    onBlur={() => {
                        if (localValue !== value) onCommit(localValue);
                    }}
                    onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                            if (localValue !== value) onCommit(localValue);
                            e.target.blur();
                        }
                    }}
                    placeholder={placeholder}
                />
            );
        };

        const Select = ({ label, value, onChange, options, name }) => (
            <div className="flex flex-col gap-1.5 w-full">
                {label && <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{label}</label>}
                <div className="relative">
                    <select
                        name={name}
                        value={value}
                        onChange={onChange}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white appearance-none focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors text-sm font-medium"
                    >
                        {options.map(opt => (
                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                    </select>
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                        ‚ñº
                    </div>
                </div>
            </div>
        );

        // --- ESTADO INICIAL Y CONFIGURACI√ìN ---

        const INITIAL_FIXED_TEMPLATE = [
            { id: 1, name: 'Alquiler', projected: 450000, real: 450000, paid: true, endMonth: '' },
            { id: 2, name: 'Internet', projected: 35000, real: 0, paid: false, endMonth: '' },
            { id: 3, name: 'Luz', projected: 25000, real: 0, paid: false, endMonth: '' },
            { id: 4, name: 'Gas', projected: 15000, real: 0, paid: false, endMonth: '' },
            { id: 5, name: 'Gimnasio', projected: 28000, real: 28000, paid: true, endMonth: '' },
        ];

        const INITIAL_CARDS = [
            { id: 1, name: 'Visa Galicia', bank: 'Galicia', closingDay: 25, dueDay: 5, color: 'bg-orange-500' },
            { id: 2, name: 'Master BBVA', bank: 'BBVA', closingDay: 20, dueDay: 2, color: 'bg-blue-600' },
        ];

        const INITIAL_DATA = {
            transactions: [
                { id: 1, type: 'income', amount: 1850000, category: 'Sueldo', description: 'Sueldo Mensual', user: 'Dario', date: '2026-02-01', monthKey: '2026-02', method: 'Banco' },
                { id: 2, type: 'income', amount: 1400000, category: 'Sueldo', description: 'Sueldo Mensual', user: 'Julia', date: '2026-02-01', monthKey: '2026-02', method: 'Banco' },
                { id: 3, type: 'expense', amount: 12000, category: 'Delivery', description: 'Cena Viernes', user: 'Julia', date: '2026-02-07', monthKey: '2026-02', method: 'Efectivo' },
            ],
            fixedExpensesHistory: {
                '2026-02': INITIAL_FIXED_TEMPLATE
            },
            savingsGoals: [
                { id: 1, name: 'Fondo de Emergencia', target: 5000, current: 1200, currency: 'USD' },
                { id: 2, name: 'Vacaciones 2026', target: 2000, current: 450, currency: 'USD' },
            ],
            creditCards: [], // Initialize empty to fetch from DB
            exchangeRate: 1120
        };

        const CATEGORIES_EXPENSE = [
            { value: 'Supermercado', label: 'üõí Supermercado' },
            { value: 'Servicios', label: 'üí° Servicios' },
            { value: 'Alquiler', label: 'üè† Alquiler' },
            { value: 'Auto', label: 'üöó Auto' },
            { value: 'Salud', label: 'üíä Salud' },
            { value: 'Entretenimiento', label: 'üçø Entretenimiento' },
            { value: 'Delivery', label: 'üõµ Delivery' },
            { value: 'Mascotas', label: 'üê∂ Mascotas' },
            { value: 'Ropa', label: 'üëï Ropa' },
            { value: 'Ahorro', label: 'üê∑ Ahorro' },
            { value: 'Otros', label: 'üì¶ Otros' },
        ];

        const CATEGORIES_INCOME = [
            { value: 'Sueldo', label: 'üíº Sueldo' },
            { value: 'Ventas', label: 'üìà Ventas' },
            { value: 'Inversiones', label: 'üí∞ Inversiones' },
            { value: 'Regalo', label: 'üéÅ Regalo' },
        ];

        const USERS = [
            { value: 'Dario', label: 'Dario' },
            { value: 'Julia', label: 'Julia' },
            { value: 'Compartido', label: 'Compartido' },
        ];

        const METHODS = [
            { value: 'Efectivo', label: 'üíµ Efectivo' },
            { value: 'D√©bito', label: 'üí≥ D√©bito' },
            { value: 'Cr√©dito', label: 'üí≥ Cr√©dito' },
            { value: 'MercadoPago', label: 'üì≤ MercadoPago' },
            { value: 'Transferencia', label: 'üè¶ Transferencia' },
        ];

        // Helpers
        const getMonthKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        };

        const getDisplayMonth = (date) => {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        };

        const getShortDisplayMonth = (date) => {
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            return `${months[date.getMonth()]} ${date.getFullYear().toString().slice(-2)}`;
        };

        // --- APP PRINCIPAL ---

        const App = () => {
            // --- STATE MANAGEMENT ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [currencyMode, setCurrencyMode] = useState('ARS'); // 'ARS' or 'USD'
            const [data, setData] = useState(INITIAL_DATA);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    const fetchedData = await SupabaseService.getAllData();
                    if (fetchedData) {
                        setData(fetchedData);
                    }
                    setLoading(false);
                };
                loadData();
            }, []);

            // --- HELPERS DE FORMATO ---
            const formatMoneyARS = (amount) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 }).format(amount);
            const formatMoneyUSD = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);

            const formatValue = (amount, baseCurrency = 'ARS') => {
                if (baseCurrency === 'ARS') {
                    if (currencyMode === 'ARS') return formatMoneyARS(amount);
                    return formatMoneyUSD(amount / (data.exchangeRate || 1));
                } else {
                    if (currencyMode === 'USD') return formatMoneyUSD(amount);
                    return formatMoneyARS(amount * (data.exchangeRate || 1));
                }
            };

            // --- NAVEGACION MES ---
            const currentMonthKey = useMemo(() => getMonthKey(currentDate), [currentDate]);

            const navigateMonth = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(currentDate.getMonth() + direction);
                setCurrentDate(newDate);
            };

            // --- LOGICA GASTOS FIJOS ---
            const currentFixedExpenses = useMemo(() => {
                if (data.fixedExpensesHistory[currentMonthKey]) {
                    return data.fixedExpensesHistory[currentMonthKey];
                }
                // Better logic: Find the most recent previous month in history
                const historyKeys = Object.keys(data.fixedExpensesHistory).sort();
                // Find the largest key that is smaller than currentMonthKey
                const previousKey = historyKeys.reverse().find(k => k < currentMonthKey);

                const prevExpenses = previousKey ? data.fixedExpensesHistory[previousKey] : INITIAL_FIXED_TEMPLATE;

                const activeExpenses = prevExpenses.filter(e => {
                    if (!e.endMonth) return true;
                    return e.endMonth >= currentMonthKey;
                });
                return activeExpenses.map(e => ({ ...e, real: 0, paid: false }));
            }, [data.fixedExpensesHistory, currentMonthKey]);

            useEffect(() => {
                if (!data.fixedExpensesHistory[currentMonthKey]) {
                    setData(prev => ({
                        ...prev,
                        fixedExpensesHistory: {
                            ...prev.fixedExpensesHistory,
                            [currentMonthKey]: currentFixedExpenses
                        }
                    }));
                }
            }, [currentMonthKey, currentFixedExpenses, data.fixedExpensesHistory]);

            // --- CALCULOS ---
            const monthTransactions = data.transactions.filter(t => t.monthKey === currentMonthKey);

            const totalIncome = monthTransactions
                .filter(t => t.type === 'income')
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const totalVariableExpenses = monthTransactions
                .filter(t => t.type === 'expense' && t.category !== 'Ahorro')
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const totalFixedExpensesReal = currentFixedExpenses.reduce((acc, curr) => acc + Number(curr.real), 0);

            const totalSavingsContrib = monthTransactions
                .filter(t => t.type === 'expense' && t.category === 'Ahorro')
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const totalExpenses = totalVariableExpenses + totalFixedExpensesReal;
            const balance = totalIncome - totalExpenses - totalSavingsContrib;

            // --- ACCIONES ---
            const addTransaction = async (transaction) => {
                let newTransactions = [];
                // Fix timezone issue: Treat YYYY-MM-DD input as local time
                const purchaseDateObj = new Date(transaction.purchaseDate + 'T00:00:00');

                if (transaction.type === 'expense' && transaction.method === 'Cr√©dito' && transaction.cardId) {
                    const selectedCard = data.creditCards.find(c => c.id === Number(transaction.cardId));
                    const closingDay = selectedCard ? Number(selectedCard.closingDay) : 25;

                    const interestMultiplier = 1 + (Number(transaction.interest || 0) / 100);
                    const discountMultiplier = 1 - (Number(transaction.discount || 0) / 100);
                    const totalAmount = Number(transaction.amount) * interestMultiplier * discountMultiplier;
                    const installmentAmount = totalAmount / Number(transaction.installments);

                    const purchaseDay = purchaseDateObj.getDate();
                    let startPaymentDate = new Date(purchaseDateObj);
                    startPaymentDate.setDate(1);

                    if (purchaseDay <= closingDay) {
                        startPaymentDate.setMonth(startPaymentDate.getMonth() + 1);
                    } else {
                        startPaymentDate.setMonth(startPaymentDate.getMonth() + 2);
                    }

                    for (let i = 0; i < Number(transaction.installments); i++) {
                        const paymentDate = new Date(startPaymentDate);
                        paymentDate.setMonth(startPaymentDate.getMonth() + i);

                        newTransactions.push({
                            ...transaction,
                            id: Date.now() + i,
                            amount: installmentAmount,
                            originalAmount: transaction.amount,
                            date: paymentDate.toISOString().split('T')[0],
                            monthKey: getMonthKey(paymentDate),
                            description: `${transaction.description || transaction.category} (${i + 1}/${transaction.installments})`,
                            isInstallment: true,
                            cardName: selectedCard ? selectedCard.name : 'Tarjeta'
                        });
                    }

                } else {
                    const dateObj = new Date();
                    newTransactions.push({
                        ...transaction,
                        id: Date.now(),
                        date: dateObj.toISOString().split('T')[0],
                        monthKey: getMonthKey(dateObj)
                    });
                }

                // Sync with Supabase
                const results = await Promise.all(newTransactions.map(t => SupabaseService.addTransaction(t)));

                if (results.every(Boolean)) {
                    setData(prev => ({
                        ...prev,
                        transactions: [...newTransactions, ...prev.transactions]
                    }));
                    setShowAddModal(false);
                } else {
                    alert("Error al guardar en Supabase. Intenta nuevamente.");
                }
            };

            const updateTransaction = async (updatedTransaction) => {
                // Ensure date object for monthKey
                const dateObj = new Date(updatedTransaction.purchaseDate + 'T00:00:00');
                const transactionToSave = {
                    ...updatedTransaction,
                    date: dateObj.toISOString().split('T')[0],
                    monthKey: getMonthKey(dateObj)
                };

                const success = await SupabaseService.updateTransaction(transactionToSave);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        transactions: prev.transactions.map(t => t.id === updatedTransaction.id ? transactionToSave : t)
                    }));
                    setShowAddModal(false);
                    setEditingTransaction(null);
                }
            };

            const deleteTransaction = async (id) => {
                if (!confirm('¬øEst√°s seguro de que deseas eliminar esta transacci√≥n?')) return;

                const success = await SupabaseService.deleteTransaction(id);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        transactions: prev.transactions.filter(t => t.id !== id)
                    }));
                }
            };

            const openEditModal = (transaction) => {
                setEditingTransaction(transaction);
                setShowAddModal(true);
            };

            const updateFixedExpense = async (id, field, value) => {
                const success = await SupabaseService.updateFixedExpense(id, field, value);
                if (success) {
                    const updatedExpenses = currentFixedExpenses.map(item =>
                        item.id === id ? { ...item, [field]: (field === 'paid' || field === 'name' || field === 'endMonth') ? value : Number(value) } : item
                    );
                    setData(prev => ({
                        ...prev,
                        fixedExpensesHistory: {
                            ...prev.fixedExpensesHistory,
                            [currentMonthKey]: updatedExpenses
                        }
                    }));
                }
            };

            const addFixedExpense = async () => {
                const newExpense = { id: Date.now(), name: '', projected: 0, real: 0, paid: false, endMonth: '' };
                const success = await SupabaseService.addFixedExpense(newExpense, currentMonthKey);
                if (success) {
                    const updatedExpenses = [...currentFixedExpenses, newExpense];
                    setData(prev => ({
                        ...prev,
                        fixedExpensesHistory: {
                            ...prev.fixedExpensesHistory,
                            [currentMonthKey]: updatedExpenses
                        }
                    }));
                }
            };

            const deleteFixedExpense = async (id) => {
                const success = await SupabaseService.deleteFixedExpense(id);
                if (success) {
                    const updatedExpenses = currentFixedExpenses.filter(item => item.id !== id);
                    setData(prev => ({
                        ...prev,
                        fixedExpensesHistory: {
                            ...prev.fixedExpensesHistory,
                            [currentMonthKey]: updatedExpenses
                        }
                    }));
                }
            };

            const addCard = async () => {
                const newCard = {
                    id: Date.now(),
                    name: 'Nueva Tarjeta',
                    bank: '',
                    closingDay: 25,
                    dueDay: 5,
                    color: 'bg-slate-600',
                    previousAmount: 0
                };
                const success = await SupabaseService.addCard(newCard);
                if (success) {
                    setData(prev => ({ ...prev, creditCards: [...prev.creditCards, newCard] }));
                }
            };

            const updateCard = async (id, field, value) => {
                const success = await SupabaseService.updateCard(id, field, value);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        creditCards: prev.creditCards.map(c => c.id === id ? { ...c, [field]: value } : c)
                    }));
                }
            };

            const deleteCard = async (id) => {
                const success = await SupabaseService.deleteCard(id);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        creditCards: prev.creditCards.filter(c => c.id !== id)
                    }));
                }
            };

            const addSavingsGoal = async () => {
                const newGoal = { id: Date.now(), name: 'Nueva Meta', target: 0, current: 0, currency: 'USD' };
                const success = await SupabaseService.addGoal(newGoal);
                if (success) {
                    setData(prev => ({ ...prev, savingsGoals: [...prev.savingsGoals, newGoal] }));
                }
            };

            const updateSavingsGoal = async (id, field, value) => {
                const success = await SupabaseService.updateGoal(id, field, value);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        savingsGoals: prev.savingsGoals.map(g => g.id === id ? { ...g, [field]: field === 'name' ? value : Number(value) } : g)
                    }));
                }
            };

            const updateSavingsAmount = async (id, amount) => {
                const goal = data.savingsGoals.find(g => g.id === id);
                if (!goal) return;
                const newAmount = Math.max(0, goal.current + amount);
                const success = await SupabaseService.updateGoal(id, 'current', newAmount);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        savingsGoals: prev.savingsGoals.map(g => g.id === id ? { ...g, current: newAmount } : g)
                    }));
                }
            };

            const deleteSavingsGoal = async (id) => {
                const success = await SupabaseService.deleteGoal(id);
                if (success) {
                    setData(prev => ({
                        ...prev,
                        savingsGoals: prev.savingsGoals.filter(g => g.id !== id)
                    }));
                }
            };

            // --- MODAL COMPONENT ---
            const AddTransactionModal = () => {
                const [type, setType] = useState(editingTransaction ? editingTransaction.type : 'expense');
                const [formData, setFormData] = useState(editingTransaction ? {
                    ...editingTransaction,
                    user: editingTransaction.user_name || editingTransaction.user, // Handle potential inconsistent field naming
                    purchaseDate: editingTransaction.date || editingTransaction.purchaseDate
                } : {
                    amount: '',
                    category: 'Supermercado',
                    user: 'Dario',
                    method: 'D√©bito',
                    cardId: data.creditCards.length > 0 ? data.creditCards[0].id : '',
                    description: '',
                    installments: 1,
                    interest: 0,
                    discount: 0,
                    purchaseDate: new Date().toISOString().split('T')[0]
                });

                useEffect(() => {
                    if (!showAddModal) setEditingTransaction(null);
                }, [showAddModal]);

                const calculatedTotal = () => {
                    if (!formData.amount) return 0;
                    let total = Number(formData.amount);
                    if (type === 'expense' && formData.method === 'Cr√©dito') {
                        const interest = Number(formData.interest || 0);
                        const discount = Number(formData.discount || 0);
                        total = total * (1 + interest / 100) * (1 - discount / 100);
                    }
                    return total;
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!formData.amount) return;
                    if (editingTransaction) {
                        updateTransaction({ ...formData, type, id: editingTransaction.id });
                    } else {
                        addTransaction({ ...formData, type });
                    }
                };

                return (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                        <div className="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 overflow-hidden shadow-2xl animate-slide-up relative max-h-[90vh] overflow-y-auto">

                            <button onClick={() => setShowAddModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white z-10">
                                <X size={24} />
                            </button>

                            <div className="flex bg-slate-800 p-1 mx-6 mt-6 rounded-xl">
                                <button
                                    onClick={() => { setType('expense'); setFormData({ ...formData, category: 'Supermercado' }); }}
                                    className={`flex-1 py-2 text-sm font-bold rounded-lg transition-colors ${type === 'expense' ? 'bg-rose-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    GASTO
                                </button>
                                <button
                                    onClick={() => { setType('income'); setFormData({ ...formData, category: 'Sueldo' }); }}
                                    className={`flex-1 py-2 text-sm font-bold rounded-lg transition-colors ${type === 'income' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}
                                >
                                    INGRESO
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="p-6 space-y-4">
                                <div className="text-center mb-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Monto Base (ARS)</label>
                                    <div className="relative inline-block w-full">
                                        <span className="absolute left-8 top-1/2 -translate-y-1/2 text-2xl text-slate-500">$</span>
                                        <input
                                            autoFocus
                                            type="number"
                                            value={formData.amount}
                                            onChange={e => setFormData({ ...formData, amount: e.target.value })}
                                            className="w-full bg-slate-800 border-2 border-slate-700 focus:border-amber-500 rounded-2xl py-4 pl-12 pr-4 text-3xl font-bold text-white text-center focus:outline-none transition-colors"
                                            placeholder="0"
                                        />
                                    </div>

                                    {type === 'expense' && formData.method === 'Cr√©dito' && (formData.interest > 0 || formData.discount > 0) && (
                                        <div className="mt-2 text-emerald-400 text-sm font-bold bg-emerald-500/10 py-1 px-3 rounded-full inline-block animate-fade-in">
                                            Final: {formatMoneyARS(calculatedTotal())} ({formData.installments} x {formatMoneyARS(calculatedTotal() / formData.installments)})
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <Select
                                        label="Categor√≠a"
                                        options={type === 'expense' ? CATEGORIES_EXPENSE : CATEGORIES_INCOME}
                                        value={formData.category}
                                        onChange={e => setFormData({ ...formData, category: e.target.value })}
                                    />
                                    <Select
                                        label="Usuario"
                                        options={USERS}
                                        value={formData.user}
                                        onChange={e => setFormData({ ...formData, user: e.target.value })}
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <Select
                                        label="M√©todo de Pago"
                                        options={METHODS}
                                        value={formData.method}
                                        onChange={e => setFormData({ ...formData, method: e.target.value })}
                                    />
                                    <Input
                                        label="Descripci√≥n"
                                        placeholder="Opcional"
                                        value={formData.description}
                                        onChange={e => setFormData({ ...formData, description: e.target.value })}
                                    />
                                </div>

                                {/* SECCI√ìN DIN√ÅMICA DE TARJETA */}
                                {type === 'expense' && formData.method === 'Cr√©dito' && (
                                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4 animate-slide-up space-y-4">
                                        <div className="text-xs font-bold text-amber-500 uppercase tracking-wider flex items-center gap-2 border-b border-slate-700 pb-2">
                                            <CreditCard size={14} /> Opciones de Tarjeta
                                        </div>

                                        <div className="col-span-2">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-1.5">Seleccionar Tarjeta</label>
                                            <div className="relative">
                                                <select
                                                    value={formData.cardId}
                                                    onChange={e => setFormData({ ...formData, cardId: e.target.value })}
                                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-white appearance-none focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors text-sm font-medium"
                                                >
                                                    {data.creditCards.map(card => (
                                                        <option key={card.id} value={card.id}>{card.name} (Cierra el {card.closingDay})</option>
                                                    ))}
                                                    {data.creditCards.length === 0 && <option value="">Sin tarjetas creadas</option>}
                                                </select>
                                                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">‚ñº</div>
                                            </div>
                                            {data.creditCards.length === 0 && (
                                                <p className="text-[10px] text-rose-400 mt-1">‚ö†Ô∏è Crea una tarjeta en la secci√≥n 'Tarjetas' primero.</p>
                                            )}
                                        </div>

                                        <div className="grid grid-cols-3 gap-3">
                                            <div className="col-span-3">
                                                <Input
                                                    label="Fecha Compra"
                                                    type="date"
                                                    value={formData.purchaseDate}
                                                    onChange={e => setFormData({ ...formData, purchaseDate: e.target.value })}
                                                />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-3 gap-3">
                                            <Input
                                                label="Cuotas"
                                                type="number"
                                                value={formData.installments}
                                                onChange={e => setFormData({ ...formData, installments: e.target.value })}
                                            />
                                            <Input
                                                label="Int. %"
                                                type="number"
                                                value={formData.interest}
                                                onChange={e => setFormData({ ...formData, interest: e.target.value })}
                                            />
                                            <Input
                                                label="Desc. %"
                                                type="number"
                                                value={formData.discount}
                                                onChange={e => setFormData({ ...formData, discount: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="pt-2">
                                    <button
                                        type="submit"
                                        className={`w-full py-4 rounded-xl font-bold text-slate-900 text-lg shadow-xl transition-transform active:scale-95 ${type === 'expense' ? 'bg-amber-500 hover:bg-amber-400' : 'bg-emerald-500 hover:bg-emerald-400'}`}
                                    >
                                        {editingTransaction ? 'Actualizar Transacci√≥n' : (type === 'expense' ? 'Guardar Gasto' : 'Guardar Ingreso')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            // --- VISTAS ---

            const DashboardView = () => (
                <div className="space-y-6 pb-24 animate-fade-in">
                    {/* Dashboard Grid - Full width 'Disponible', then 2 columns below for Income/Expense */}
                    <div className="flex flex-col gap-4">
                        <Card className="p-6 md:p-8 bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-amber-500 relative overflow-hidden text-center">
                            <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
                                <Wallet size={120} className="text-white" />
                            </div>
                            <div className="relative z-10 flex flex-col items-center">
                                <p className="text-slate-400 text-xs md:text-sm font-bold uppercase tracking-widest mb-2">Disponible {getDisplayMonth(currentDate)}</p>
                                <h2 className="text-4xl md:text-6xl font-bold text-white mb-3 tracking-tight break-all">{formatValue(balance)}</h2>
                                <p className="text-amber-400 font-mono text-sm md:text-xl flex items-center justify-center gap-2 font-bold opacity-80">
                                    {currencyMode === 'ARS' ? formatMoneyUSD(balance / data.exchangeRate) : formatMoneyARS(balance)}
                                    <span className="text-xs text-slate-400 font-sans tracking-wide font-normal">(aprox)</span>
                                </p>
                            </div>
                        </Card>

                        <div className="grid grid-cols-2 gap-4">
                            <Card className="p-4 md:p-6 flex flex-col justify-center items-center text-center border-l-4 border-l-emerald-500 relative overflow-hidden">
                                <p className="text-[10px] md:text-xs text-emerald-400 font-bold uppercase tracking-wider mb-2">+ INGRESOS</p>
                                <p className="text-lg md:text-2xl font-bold text-white break-all">{formatValue(totalIncome)}</p>
                            </Card>

                            <Card className="p-4 md:p-6 flex flex-col justify-center items-center text-center border-l-4 border-l-rose-500 relative overflow-hidden">
                                <p className="text-[10px] md:text-xs text-rose-400 font-bold uppercase tracking-wider mb-2">- GASTOS TOTALES</p>
                                <p className="text-lg md:text-2xl font-bold text-white break-all">{formatValue(totalExpenses + totalSavingsContrib)}</p>
                            </Card>
                        </div>
                    </div>


                    <Card className="p-6">
                        <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <PieChart className="text-amber-500" size={20} /> Distribuci√≥n Mensual
                        </h3>
                        <div className="space-y-5">
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="text-slate-300 font-medium">Gastos Fijos (Real)</span>
                                    <span className="text-white font-mono">{formatValue(totalFixedExpensesReal)}</span>
                                </div>
                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div
                                        className="h-full bg-blue-500 rounded-full"
                                        style={{ width: `${Math.min((totalFixedExpensesReal / (totalExpenses + totalSavingsContrib || 1)) * 100, 100)}%` }}
                                    ></div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="text-slate-300 font-medium">Gastos Variables</span>
                                    <span className="text-white font-mono">{formatValue(totalVariableExpenses)}</span>
                                </div>
                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div
                                        className="h-full bg-rose-500 rounded-full"
                                        style={{ width: `${Math.min((totalVariableExpenses / (totalExpenses + totalSavingsContrib || 1)) * 100, 100)}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </Card>

                    <Card className="p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <List className="text-amber-500" size={20} /> Movimientos {getDisplayMonth(currentDate)}
                            </h3>
                            <button onClick={() => setActiveTab('transactions')} className="text-xs text-amber-500 hover:text-amber-400 font-bold uppercase tracking-wider">Ver Todo</button>
                        </div>
                        <div className="space-y-3">
                            {monthTransactions.slice(0, 5).map(t => (
                                <div key={t.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl hover:bg-slate-700/50 transition-colors border border-transparent hover:border-slate-600">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${t.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                            {t.type === 'income' ? <TrendingUp size={18} /> : <CreditCard size={18} />}
                                        </div>
                                        <div>
                                            <p className="text-white font-medium text-sm">{t.category}</p>
                                            <div className="flex items-center gap-2 text-[10px] text-slate-400 uppercase font-bold tracking-wide">
                                                <span className="flex items-center gap-1"><User size={10} /> {t.user}</span>
                                                {t.installments > 1 && (
                                                    <span className="bg-amber-500/20 text-amber-400 px-1.5 py-0.5 rounded flex items-center gap-0.5">
                                                        {t.description.match(/(\d+\/\d+)/)?.[0] || `x${t.installments}`}
                                                    </span>
                                                )}
                                                {t.cardName && (
                                                    <span className="bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded font-bold">
                                                        {t.cardName}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-mono font-bold text-sm ${t.type === 'income' ? 'text-emerald-400' : 'text-white'}`}>
                                            {t.type === 'income' ? '+' : '-'}{formatValue(t.amount)}
                                        </p>
                                        <p className="text-[10px] text-slate-500 font-mono">
                                            {currencyMode === 'ARS' ? formatMoneyUSD(t.amount / data.exchangeRate) : formatMoneyARS(t.amount * data.exchangeRate)}
                                        </p>
                                    </div>
                                </div>
                            ))}
                            {monthTransactions.length === 0 && (
                                <div className="text-center py-8 text-slate-500 text-sm">
                                    No hay movimientos en este mes.
                                </div>
                            )}
                        </div>
                    </Card>

                </div >
            );

            const TransactionsView = () => (
                <div className="pb-24 animate-fade-in">
                    <h3 className="text-xl font-bold text-white mb-4 px-2">Historial - {getDisplayMonth(currentDate)}</h3>
                    <div className="space-y-3">
                        {monthTransactions.map((t) => (
                            <Card key={t.id} className="p-4 flex flex-col gap-2 relative group">
                                <div className="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800/80 p-1 rounded-lg">
                                    <button onClick={() => openEditModal(t)} className="text-slate-400 hover:text-amber-500 p-1">
                                        <Edit2 size={16} />
                                    </button>
                                    <button onClick={() => deleteTransaction(t.id)} className="text-slate-400 hover:text-rose-500 p-1">
                                        <Trash2 size={16} />
                                    </button>
                                </div>
                                <div className="flex justify-between items-start">
                                    <div className="flex gap-3">
                                        <div className={`mt-1 w-8 h-8 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                            {t.type === 'income' ? <TrendingUp size={16} /> : <CreditCard size={16} />}
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-white">{t.category}</h4>
                                            <p className="text-sm text-slate-400">{t.description || 'Sin descripci√≥n'}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`text-lg font-bold font-mono ${t.type === 'income' ? 'text-emerald-400' : 'text-white'}`}>
                                            {t.type === 'income' ? '+' : '-'}{formatValue(t.amount)}
                                        </p>
                                        <p className="text-xs text-slate-500 font-mono">
                                            {currencyMode === 'ARS' ? formatMoneyUSD(t.amount / data.exchangeRate) : formatMoneyARS(t.amount * data.exchangeRate)}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center border-t border-slate-700/50 pt-2 mt-1">
                                    <div className="flex gap-2 text-xs">
                                        <span className="bg-slate-700 text-slate-300 px-2 py-1 rounded flex items-center gap-1 font-bold">
                                            <User size={10} /> {t.user}
                                        </span>
                                        <span className="bg-slate-700/50 text-slate-400 px-2 py-1 rounded">
                                            {t.method}
                                        </span>
                                        {t.installments > 1 && (
                                            <span className="bg-amber-500/10 text-amber-500 px-2 py-1 rounded font-bold">
                                                {t.description.match(/(\d+\/\d+)/)?.[0] || `x${t.installments}`}
                                            </span>
                                        )}
                                        {t.cardName && (
                                            <span className="bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded font-bold">
                                                {t.cardName}
                                            </span>
                                        )}
                                    </div>
                                    <span className="text-xs text-slate-500">{t.date}</span>
                                </div>
                            </Card>
                        ))}
                        {monthTransactions.length === 0 && (
                            <div className="text-center py-10 opacity-50">
                                <p className="text-slate-400">Sin movimientos en este mes.</p>
                            </div>
                        )}
                    </div>
                </div>
            );

            const FixedExpensesView = () => (
                <div className="space-y-6 pb-24 animate-fade-in">
                    <Card className="p-6">
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                <Home className="text-blue-500" /> Gastos Fijos ({getDisplayMonth(currentDate)})
                            </h3>
                            <div className="flex gap-4 text-right">
                                <div>
                                    <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total Real</p>
                                    <p className="text-lg font-mono text-amber-500">{formatValue(totalFixedExpensesReal)}</p>
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto -mx-6 px-6 sm:mx-0 sm:px-0">
                            <table className="w-full text-left border-collapse min-w-[500px]">
                                <thead>
                                    <tr className="text-xs text-slate-400 uppercase border-b border-slate-700">
                                        <th className="py-3 pl-2 w-1/3">Concepto</th>
                                        <th className="py-3 text-right">Proyectado</th>
                                        <th className="py-3 text-right">Real</th>
                                        <th className="py-3 text-center">Pagado</th>
                                        <th className="py-3 text-center w-24">Fin?</th>
                                        <th className="py-3 text-center w-10"></th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700/50">
                                    {currentFixedExpenses.map(expense => (
                                        <tr key={expense.id} className="group hover:bg-slate-700/30 transition-colors">
                                            <td className="py-2 pl-2 font-medium text-white">
                                                <input
                                                    type="text"
                                                    className="bg-transparent w-full text-white font-medium focus:outline-none placeholder-slate-600 border-b border-transparent focus:border-amber-500/50 transition-colors py-2"
                                                    value={expense.name}
                                                    placeholder="Nuevo Gasto"
                                                    onChange={(e) => updateFixedExpense(expense.id, 'name', e.target.value)}
                                                />
                                            </td>
                                            <td className="py-2 text-right relative">
                                                <input
                                                    type="number"
                                                    className="bg-transparent text-right w-24 text-slate-400 focus:text-white focus:outline-none border-b border-transparent focus:border-amber-500 transition-colors py-2"
                                                    value={expense.projected}
                                                    onChange={(e) => updateFixedExpense(expense.id, 'projected', e.target.value)}
                                                />
                                                {currencyMode === 'USD' && (
                                                    <div className="text-[9px] text-amber-500 absolute bottom-0 right-0">{formatValue(expense.projected)}</div>
                                                )}
                                            </td>
                                            <td className="py-2 text-right relative">
                                                <input
                                                    type="number"
                                                    className={`bg-transparent text-right w-24 font-bold focus:outline-none border-b border-transparent focus:border-amber-500 transition-colors py-2 ${Number(expense.real) > Number(expense.projected) ? 'text-rose-400' : 'text-emerald-400'}`}
                                                    value={expense.real}
                                                    onChange={(e) => updateFixedExpense(expense.id, 'real', e.target.value)}
                                                />
                                                {currencyMode === 'USD' && (
                                                    <div className="text-[9px] text-amber-500 absolute bottom-0 right-0">{formatValue(expense.real)}</div>
                                                )}
                                            </td>
                                            <td className="py-2 text-center">
                                                <button
                                                    onClick={() => updateFixedExpense(expense.id, 'paid', !expense.paid)}
                                                    className={`p-1.5 rounded-lg transition-all ${expense.paid ? 'bg-emerald-500 text-slate-900 shadow-lg shadow-emerald-500/20' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                                                >
                                                    <Check size={16} strokeWidth={3} />
                                                </button>
                                            </td>
                                            <td className="py-2 text-center">
                                                <input
                                                    type="month"
                                                    className="bg-transparent text-xs w-24 text-slate-400 focus:text-white focus:outline-none border-b border-transparent focus:border-amber-500 transition-colors py-2 text-center"
                                                    value={expense.endMonth || ''}
                                                    onChange={(e) => updateFixedExpense(expense.id, 'endMonth', e.target.value)}
                                                />
                                            </td>
                                            <td className="py-2 text-center">
                                                <button
                                                    onClick={() => deleteFixedExpense(expense.id)}
                                                    className="p-1.5 rounded-lg text-slate-600 hover:text-rose-400 hover:bg-rose-500/10 transition-colors"
                                                    title="Eliminar Gasto"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="mt-6 flex justify-end">
                            <Button variant="ghost" className="border border-slate-700 text-xs" onClick={addFixedExpense}>
                                + Agregar Nuevo Gasto Fijo
                            </Button>
                        </div>
                    </Card>
                </div>
            );

            const CardsView = () => {
                const calculateCardTotal = (card) => {
                    const monthTotal = monthTransactions
                        .filter(t => t.method === 'Cr√©dito' && Number(t.cardId) === card.id)
                        .reduce((acc, curr) => acc + Number(curr.amount), 0);
                    return Number(card.previousAmount || 0) + monthTotal;
                };

                return (
                    <div className="space-y-6 pb-24 animate-fade-in">
                        <Card className="p-6 bg-slate-800">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="p-3 bg-indigo-500/20 rounded-xl text-indigo-400">
                                    <CreditCard size={24} />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-white">Mis Tarjetas</h3>
                                    <p className="text-slate-400 text-sm">Gestiona tus pl√°sticos y vencimientos</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {data.creditCards.map(card => {
                                    const totalToPay = calculateCardTotal(card.id);
                                    return (
                                        <div key={card.id} className="relative bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-5 border border-slate-600 shadow-xl overflow-hidden group">
                                            <div className={`absolute top-0 right-0 w-24 h-24 ${card.color || 'bg-slate-500'} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>

                                            <div className="flex justify-between items-start mb-4 relative z-10">
                                                <div className="space-y-1 overflow-hidden flex-1">
                                                    <StableInput
                                                        className="bg-transparent text-white font-bold text-lg focus:outline-none placeholder-slate-400 w-full"
                                                        value={card.name}
                                                        onCommit={(val) => updateCard(card.id, 'name', val)}
                                                        placeholder="Nombre Tarjeta"
                                                    />
                                                    <div className="flex items-center gap-1 text-slate-400 text-xs uppercase tracking-wide">
                                                        <Landmark size={12} />
                                                        <StableInput
                                                            className="bg-transparent text-slate-400 focus:text-white focus:outline-none placeholder-slate-500 w-full"
                                                            value={card.bank}
                                                            onCommit={(val) => updateCard(card.id, 'bank', val)}
                                                            placeholder="Banco"
                                                        />
                                                    </div>
                                                </div>
                                                <button onClick={() => deleteCard(card.id)} className="text-slate-500 hover:text-rose-400 p-1 flex-shrink-0"><Trash2 size={16} /></button>
                                            </div>

                                            <div className="mb-4 relative z-10 bg-slate-900/30 p-2 rounded-xl border border-slate-700/50">
                                                <label className="text-[9px] text-slate-500 font-bold uppercase block mb-1">Monto Previo (Deuda Tra√≠da)</label>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-slate-400 text-sm font-mono">$</span>
                                                    <StableInput
                                                        type="number"
                                                        className="bg-transparent text-amber-500 text-sm font-bold focus:outline-none w-full"
                                                        value={card.previousAmount}
                                                        onCommit={(val) => updateCard(card.id, 'previousAmount', Number(val))}
                                                        placeholder="0.00"
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4 mb-4 relative z-10">
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Cierre</label>
                                                    <div className="flex items-center gap-1 bg-slate-900/50 rounded-lg px-2 py-1.5 border border-slate-600">
                                                        <Calendar size={12} className="text-indigo-400" />
                                                        <span className="text-slate-400 text-xs">D√≠a</span>
                                                        <StableInput
                                                            type="number"
                                                            className="bg-transparent w-8 text-white text-sm font-bold focus:outline-none text-center"
                                                            value={card.closingDay}
                                                            onCommit={(val) => updateCard(card.id, 'closingDay', Number(val))}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Vence</label>
                                                    <div className="flex items-center gap-1 bg-slate-900/50 rounded-lg px-2 py-1.5 border border-slate-600">
                                                        <CalendarClock size={12} className="text-amber-400" />
                                                        <span className="text-slate-400 text-xs">D√≠a</span>
                                                        <StableInput
                                                            type="number"
                                                            className="bg-transparent w-8 text-white text-sm font-bold focus:outline-none text-center"
                                                            value={card.dueDay}
                                                            onCommit={(val) => updateCard(card.id, 'dueDay', Number(val))}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="border-t border-slate-600 pt-3 relative z-10">
                                                <p className="text-[10px] text-slate-400 font-bold uppercase mb-1">Total a Pagar ({getDisplayMonth(currentDate)})</p>
                                                <p className="text-2xl font-bold text-white font-mono">{formatValue(calculateCardTotal(card))}</p>
                                            </div>
                                        </div>
                                    );
                                })}

                                <button
                                    onClick={addCard}
                                    className="flex flex-col items-center justify-center gap-2 border-2 border-dashed border-slate-700 rounded-2xl p-6 text-slate-500 hover:text-amber-500 hover:border-amber-500/50 hover:bg-amber-500/5 transition-all h-full min-h-[200px]"
                                >
                                    <div className="p-3 bg-slate-800 rounded-full group-hover:scale-110 transition-transform">
                                        <Plus size={24} />
                                    </div>
                                    <span className="font-bold text-sm uppercase tracking-wide">Nueva Tarjeta</span>
                                </button>
                            </div>
                        </Card>
                    </div>
                );
            };

            const SavingsView = () => (
                <div className="pb-24 animate-fade-in space-y-6">
                    <Card className="p-6 border-l-4 border-l-blue-500 bg-gradient-to-r from-slate-800 to-slate-900 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10">
                            <PiggyBank size={80} className="text-white" />
                        </div>
                        <h2 className="text-slate-400 text-xs uppercase font-bold tracking-widest">Total Ahorrado</h2>
                        <div className="flex items-end gap-3 mt-2">
                            <span className="text-4xl font-bold text-white">{formatValue(data.savingsGoals.reduce((acc, curr) => acc + curr.current, 0), 'USD')}</span>
                            <span className="text-slate-500 mb-1.5 font-medium">acumulado</span>
                        </div>
                        <p className="text-xs text-slate-500 mt-2 flex items-center gap-1">
                            <Check size={12} className="text-emerald-400" />
                            Este dinero ya est√° descontado de tu "Disponible".
                        </p>
                    </Card>

                    <div className="flex justify-between items-center px-2">
                        <h3 className="text-xl font-bold text-white">Mis Metas</h3>
                        <Button variant="secondary" className="px-3 py-2 text-xs" onClick={addSavingsGoal}>+ Nueva Meta</Button>
                    </div>

                    {data.savingsGoals.map(goal => (
                        <Card key={goal.id} className="p-5">
                            <div className="flex justify-between items-start mb-3">
                                <div className="flex-1 mr-4">
                                    <input
                                        type="text"
                                        className="bg-transparent w-full text-white font-bold text-lg focus:outline-none placeholder-slate-600 border-b border-transparent focus:border-amber-500 transition-colors"
                                        value={goal.name}
                                        onChange={(e) => updateSavingsGoal(goal.id, 'name', e.target.value)}
                                        placeholder="Nombre de la meta"
                                    />
                                </div>
                                <button onClick={() => deleteSavingsGoal(goal.id)} className="text-slate-600 hover:text-rose-400 transition-colors p-1"><Trash2 size={16} /></button>
                            </div>

                            <div className="h-4 bg-slate-900 rounded-full overflow-hidden border border-slate-700 mb-2 relative">
                                <div
                                    className="h-full bg-gradient-to-r from-blue-600 to-cyan-400 transition-all duration-1000"
                                    style={{ width: `${Math.min((goal.current / (goal.target || 1)) * 100, 100)}%` }}
                                ></div>
                            </div>

                            <div className="flex justify-between items-center text-xs mb-4 px-1">
                                <span className="text-emerald-400 font-bold">{formatValue(goal.current, 'USD')}</span>
                                <div className="flex items-center gap-1">
                                    <span className="text-slate-500">Meta:</span>
                                    <input
                                        type="number"
                                        className="bg-transparent w-16 text-right text-slate-300 focus:text-white focus:outline-none border-b border-transparent focus:border-slate-500 transition-colors"
                                        value={goal.target}
                                        onChange={(e) => updateSavingsGoal(goal.id, 'target', e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="flex justify-between items-center pt-2 border-t border-slate-700/50">
                                <p className="text-xs text-slate-500 font-bold">{Math.min(((goal.current / (goal.target || 1)) * 100), 100).toFixed(1)}% completado</p>
                                <div className="flex gap-2">
                                    <button
                                        className="p-2 bg-slate-700 hover:bg-rose-500/20 hover:text-rose-400 rounded-lg text-white transition-all active:scale-95"
                                        onClick={() => updateSavingsAmount(goal.id, -100)}
                                        title="-100 USD"
                                    >
                                        <Minus size={16} />
                                    </button>
                                    <button
                                        className="p-2 bg-slate-700 hover:bg-emerald-500/20 hover:text-emerald-400 rounded-lg text-white transition-all active:scale-95"
                                        onClick={() => updateSavingsAmount(goal.id, 100)}
                                        title="+100 USD"
                                    >
                                        <Plus size={16} />
                                    </button>
                                </div>
                            </div>
                        </Card>
                    ))}
                    {data.savingsGoals.length === 0 && (
                        <div className="text-center py-10 opacity-50 border-2 border-dashed border-slate-800 rounded-2xl">
                            <p className="text-slate-400 mb-2">A√∫n no tienes metas de ahorro.</p>
                            <p className="text-xs text-slate-600">Define para qu√© est√°s guardando dinero.</p>
                        </div>
                    )}
                </div>
            );

            // --- LAYOUT ---
            const NavBtn = ({ icon: Icon, label, active, onClick }) => (
                <button
                    onClick={onClick}
                    className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all duration-300 ${active ? 'text-amber-500' : 'text-slate-500 hover:text-slate-300'}`}
                >
                    <div className={`transition-transform duration-300 ${active ? '-translate-y-1' : ''}`}>
                        <Icon size={22} className={active ? "fill-amber-500/10 stroke-[2.5]" : "stroke-[2]"} />
                    </div>
                    <span className={`text-[10px] font-bold uppercase tracking-wide transition-opacity duration-300 ${active ? 'opacity-100' : 'opacity-70'}`}>{label}</span>
                </button>
            );

            if (loading) {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center gap-4">
                        <div className="w-12 h-12 border-4 border-slate-800 border-t-amber-500 rounded-full animate-spin"></div>
                        <p className="text-slate-500 font-bold text-sm uppercase tracking-widest animate-pulse">Sincronizando...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-950 font-sans text-slate-200 selection:bg-amber-500/30">

                    {/* Top Bar */}
                    <div className="sticky top-0 z-30 bg-slate-900/95 backdrop-blur-xl border-b border-slate-800 shadow-lg">
                        <div className="px-4 py-3 flex justify-between items-center gap-2">

                            <div className="flex items-center gap-2 sm:gap-4 flex-1">
                                <div className="bg-amber-500 p-1.5 rounded-lg shadow-lg shadow-amber-500/20 hidden sm:block">
                                    <DollarSign size={20} className="text-slate-900 stroke-[3]" />
                                </div>

                                <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                                    <button
                                        onClick={() => setCurrencyMode('ARS')}
                                        className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currencyMode === 'ARS' ? 'bg-amber-500 text-slate-900 shadow' : 'text-slate-400 hover:text-white'}`}
                                    >
                                        ARS
                                    </button>
                                    <button
                                        onClick={() => setCurrencyMode('USD')}
                                        className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${currencyMode === 'USD' ? 'bg-amber-500 text-slate-900 shadow' : 'text-slate-400 hover:text-white'}`}
                                    >
                                        USD
                                    </button>
                                </div>
                            </div>

                            <div className="flex items-center bg-slate-800 rounded-full border border-slate-700 p-1 mx-2 relative">
                                <button onClick={() => navigateMonth(-1)} className="p-1 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors z-10">
                                    <ChevronLeft size={18} />
                                </button>

                                <div className="relative mx-2">
                                    <span className="text-xs font-bold text-white w-16 text-center select-none uppercase tracking-wide block">
                                        {getShortDisplayMonth(currentDate)}
                                    </span>
                                    <input
                                        type="month"
                                        className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                                        value={getMonthKey(currentDate)}
                                        onChange={(e) => {
                                            if (e.target.value) {
                                                const [y, m] = e.target.value.split('-');
                                                setCurrentDate(new Date(parseInt(y), parseInt(m) - 1, 1));
                                            }
                                        }}
                                    />
                                </div>

                                <button onClick={() => navigateMonth(1)} className="p-1 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors z-10">
                                    <ChevronRight size={18} />
                                </button>
                            </div>

                            <div className="flex items-center gap-2 bg-slate-800 px-2 py-1.5 rounded-full border border-slate-700 group focus-within:border-amber-500 transition-colors">
                                <span className="text-[10px] text-slate-400 font-bold uppercase hidden sm:inline">USD</span>
                                <input
                                    type="number"
                                    className="bg-transparent w-12 text-right text-white font-mono font-bold text-xs focus:outline-none"
                                    value={data.exchangeRate}
                                    onChange={(e) => setData(prev => ({ ...prev, exchangeRate: Number(e.target.value) }))}
                                />
                            </div>
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <main className="max-w-3xl mx-auto p-4 md:p-6 min-h-[calc(100vh-80px)]">
                        {activeTab === 'dashboard' && <DashboardView />}
                        {activeTab === 'transactions' && <TransactionsView />}
                        {activeTab === 'fixed' && <FixedExpensesView />}
                        {activeTab === 'debt' && <CardsView />}
                        {activeTab === 'savings' && <SavingsView />}
                    </main>

                    {/* Floating Action Button (FAB) */}
                    <div className="fixed right-6 bottom-24 z-40 group">
                        <div className="absolute inset-0 bg-amber-500 rounded-full blur opacity-20 group-hover:opacity-40 transition-opacity"></div>
                        <button
                            onClick={() => setShowAddModal(true)}
                            className="relative bg-amber-500 hover:bg-amber-400 text-slate-900 p-4 rounded-full shadow-xl transition-all active:scale-90"
                        >
                            <Plus size={32} strokeWidth={3} />
                        </button>
                    </div>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 pb-safe z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                        <div className="max-w-3xl mx-auto flex justify-around items-center h-16 px-2">
                            <NavBtn icon={Home} label="Inicio" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                            <NavBtn icon={Target} label="Fijos" active={activeTab === 'fixed'} onClick={() => setActiveTab('fixed')} />
                            <div className="w-12"></div> {/* Spacer for FAB */}
                            <NavBtn icon={CreditCard} label="Tarjetas" active={activeTab === 'debt'} onClick={() => setActiveTab('debt')} />
                            <NavBtn icon={Save} label="Ahorros" active={activeTab === 'savings'} onClick={() => setActiveTab('savings')} />
                        </div>
                    </div>

                    {/* Modals */}
                    {showAddModal && <AddTransactionModal />}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>